---
title: "Electric Vehicle Population Data"
author: "Norma Quiroz"
date: "`r Sys.Date()`"
output: 
  html_document: 
   theme: cerulean
   toc: true   
   number_sections: true
   fontsize: 15 pt

---

```{r setup, include=TRUE, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
knitr::opts_chunk$set(echo = FALSE)
```


```{r, echo = FALSE}
rm(list = ls())
```

```{r Libraries, echo=FALSE}
library(tidyverse)
library(dplyr)
library(skimr)
library(ggplot2)
library(janitor)  # to clean names
library(scales) # for log scales
library(modeest) # compute mode

library(plotly)  # to plot pie
library(RColorBrewer) # to set other colors

library(tinytable) # to use tt for tables
library(gridExtra)

library(psych)  # distribution plots


```

# Introduction 

The dataset obtained from [Electric Vehicle Population Data](https://data.wa.gov/Transportation/Electric-Vehicle-Population-Data/f6w7-q2d2/about_data) contains information on the Battery Electric Vehicles (BEVs) and Plug-in Hybrid Electric Vehicles (PHEVs) registered through Washington State Department of Licensing (DOL).  The owner of the dataset is the Department of Licensing, in this way, the data format is primary  and internal. This dataset is open under the Open Database License [ODbl](https://opendatacommons.org/licenses/odbl/1-0/). 

The data consists of 17 columns describing some characteristics of the electric vehicles registered as March 21, 2025. 

* Observation: An important note about this data is that the *Electric Range* attribute is no longer maintained for *Battery Electric Vehicles* (BEVs), as newer *BEVs* typically have an electric range of 30 miles or more. A value of zero (0) was entered where the electric range had not been researched. It is not specified from which date the recording stopped or from which year vehicles are considered to have more than 30 miles of range. However, this observation will be taken into account in this analysis


Objective:
Understand which are the most frequently characteristics registered in the data set. 

Particular objective: Learn to work with missing  and zero values as well as with outliers.

## Asking Questions

To analyse data, the following questions arise:

* What is the time interval in the recollected data? 
* How many registered BEV's and Plug-in electric vehicles are there? 
* How are the electric vehicle types distributed across the model year?  
* How many manufactures (makes)  are registered? Which are the most registered makes?
* How many models are in data, Which are the models with highest enrollments?
* What is the percentage of eligibility by electric type?
* Which is the city with most registration?





#  Preparing Data for  Exploration

## Exploring data
```{r Download  file,  echo=FALSE}
# download file
data <-read_csv("C:/Users/Norma/Documents/R_Projects/Electric_Vehicle_Population/Electric_Vehicle_Population_Data_20250407.csv",show_col_types = FALSE)  
```



```{r  lenght.data, echo=FALSE}
# data lenght
lenght.data <- nrow(data)
```

```{r data.table, echo = FALSE}
# data in table form with first 4 rows
knitr::kable(data[1:4, ], caption = "Data table")
```



```{r data.skim, echo = FALSE}
# summary of data with skirm
data %>% skim() %>%
   select(skim_type,skim_variable,n_missing,character.n_unique, character.empty, character.whitespace)
          
```

For model year and electric range

```{r summary.statistic ,echo = FALSE}
#summary statistic for the ordinal attributes
year.range <- data %>% select(`Electric Range`, `Model Year`) %>% 
summary( .,na.rm = TRUE) 


knitr::kable(year.range, caption = "Summary Statistic for the year and range columns")
```













* Data is structured into 235, 692 rows and 17 columns. 
* 11 columns  are type character and 6 are numerical. 
* The data is discrete.
* From the total of columns, 15 are nominal and  only 2 are ordinal: "Model Year" and "Electric Range".
* From the total number of registered vehicles, there are only  13,763  different Vehicle Identification Numbers (VIN). 
* The data contains missing and  zero values.
* The model year interval for the registered data goes from 2000 to 2025. 
* The registered electric range is between 0 to 337 miles.



## Fixing  column names and  Selecting data for the analysis
Next, several column names have spaces and use capital letters. I prefer to work with variable names in lower case with underscores in the gaps.

```{r  clean_names, echo=FALSE}
# clean columns names
data <- clean_names(data)

```


I choose to work with the following 7 features: "city", "make,  model" , "model_year", "electric_range",  "clean_alternative_fuel_vehicle_cafv_eligibility", "electric_vehicle_type".  For easy manipulation, I also change the long names *clean_alternative_fuel_vehicle_cafv_eligibility* and *electric_vehicle_type*  by the short ones *eligibility* and *electric_type*, respectively. In those columns I also rename the long name of the rows:
*Eligibililty unknown as battery range has not been researched* is changed by *unknown*, *Clean Alternative
Fuel Vehicle Eligible* by *clean* and *Not eligible due to low battery range* by *negative*.




#  Processing Data

##  Distributions  by electric vehicle type

In the following, the selected features are grouped according to electric_type.

```{r select_features ,skimr_include_summary = FALSE, echo=FALSE}
# select data and rename columns and rows
sf <- data %>% 
  select(city, clean_alternative_fuel_vehicle_cafv_eligibility, 
         model_year, make, model, electric_range, electric_vehicle_type)  %>%
  rename(eligibility = clean_alternative_fuel_vehicle_cafv_eligibility) %>% 
  mutate(eligibility = ifelse(grepl("Clean", eligibility), "clean",
                        ifelse(grepl("unknown", eligibility), "unknown","negative"))) %>%
                             # ifelse(grepl("not", eligibility), "negative"," ")))) %>%
  rename(electric_type = electric_vehicle_type) %>%
  mutate(electric_type = ifelse(grepl("Battery", electric_type), "battery",
                          ifelse(grepl("Plug-in", electric_type),"hybrid", "other"))) 
  
```






Among the different features there is only a  moderated correlation between *eligibility* and *model_year*. 
```{r}
# plot correlations between the some features. The city and model are too large to plot here.
sf_pairs <- sf %>% select(eligibility, model_year, electric_range, electric_type)
pairs.panels(sf_pairs, main = "Correlation between eligibility and model year ")
```


```{r}
# summary statistic by type
sf.skym <- sf %>%
  dplyr::group_by(electric_type) %>% 
  skim_without_charts() 

sf.skym
```





The central tendency measures, mean and median (as p50), can be observed from the table above.  The mode for several attributes is given in the following table
```{r mode,  echo = FALSE}
# Function to compute mode
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# compute mode
mode.tab <- sf %>% 
  group_by(electric_type) %>%
  summarise( across( ,mode), .groups = "drop")

cap <- "Mode for the selected variables by type"
knitr::kable(mode.tab, caption = cap)
```


The column *model year* has a left skewed distribution. For *battery electric type*  the mode is 2023, the same as the median,  and the mean is 2022. The *plug-in hybrid* type has:  mode 2024, median 2022 and mean 2021.  The skewed distributions  are shown in the distribution plots, mean and median are represented by dashed and dotted lines respectively. Outliers are observed in the Battery type case.

```{r count, echo = FALSE}
# count the number of entries in each type
count.type <- sf %>% group_by(electric_type) %>%
  summarise(count = n())

# mean and median for electric range and model year
mean.median <- sf %>% select(electric_type, model_year, electric_range) %>% 
  group_by(electric_type) %>%
   summarise(across(c(electric_range, model_year), list(mean = mean, median =median),  na.rm = TRUE))


```



```{r, distribution_year, echo = FALSE}
# plot distribution in model year

#define colors to use
darkcols <- brewer.pal(8, "Dark2")

# count the number of model year by type
count.year <- sf %>% group_by(electric_type) %>% count(model_year) %>% 
       arrange(desc(n))

# Barplot 
ggplot(count.year, aes(x=model_year, y= n, fill = electric_type)) + geom_bar(stat= "identity") +
  geom_vline(data = mean.median, aes(xintercept= model_year_mean, color = electric_type),
                                 linetype = "dashed", size =1) +
  geom_vline(data = mean.median, aes(xintercept = model_year_median, color = electric_type),
                              linetype = "dotted", size = 1) +
  facet_wrap(~ electric_type) +
  xlab("Model Year") + ylab("Frequency in log scale") +
  labs(title= "Distribution of Electric Vehicle Type by Model Year from 2000 - 2025") +
       theme(legend.position = "none") +
  scale_fill_manual(values = darkcols[5:6]) +
  scale_y_continuous(trans='log10',
                   breaks=trans_breaks('log10', function(x) 10^x),
                    labels=trans_format('log10', math_format(10^.x))) 

```




For *electric range*, the plots show right skewed distributions in both cases, *battery* and *plug-in* vehicle type. But *battery* type has a significantly skewed due to an extremely high value at range 0. This due to the *observation* described in the introduction.

For *battery* type: mean is 50, median and mode are 0. The  *plug-in hybrid* type has:  mean 31, median 30 and mode 32. 
In the following plot, the mean and median are represented by the dashed and dotted lines respectively.

```{r, echo=FALSE}
# select colors to use
darkcols <- brewer.pal(8, "Dark2")

# bar plot
ggplot(sf, aes(x= electric_range, y= after_stat(count), fill = electric_type)) + geom_bar( na.rm=TRUE) +
       facet_wrap(~ electric_type) +
  geom_vline(data = mean.median, aes(xintercept= electric_range_mean, color = electric_type),
                                 linetype = "dashed", size =1) +
  geom_vline(data = mean.median, aes(xintercept= electric_range_median, color = electric_type),
                                 linetype = "dotted", size =1) +
      xlab("Electric Range") + ylab("Frequency in log scale") +
       labs(title= "Distribution of Electric Range  by Electric Type") +
      # theme(legend.position = "none") +
       scale_fill_manual(values = darkcols[5:6]) +
                 scale_y_continuous(trans='log10',
                    breaks=trans_breaks('log10', function(x) 10^x),
                     labels=trans_format('log10', math_format(10^.x))) 

```

```{r, echo = FALSE}
# give the max values of range
max.range <- sf %>% select(electric_range, electric_type) %>%
         group_by(electric_type) %>%
           summarise(max.range = max(electric_range, na.rm = TRUE), .groups = "drop")
tt(max.range, caption = "max values of electric range across type") %>%
  style_tt(align = "r")

```
  

  

## Outliers 


### Outliers in Model Year

The table and the boxplot below show that between 2000 and 2010, the years are intermittent, for instance,  years 2001, 2004 are not included. Also  the values obtained between 2000 and 2015 are outliers since the number of vehicles is too small compared to the rest of the years. Such outliers are also observed in the distribution plot for *model year*. 



```{r, table_model_year, echo=FALSE}
#table for the number of model year
year.tab <- sf %>% select(model_year) %>% count(model_year) %>% arrange(desc(model_year))
knitr::kable(year.tab, caption = "Count of registered vehicles by model year", align = "cc")

```



```{r, model_year_boxplot, echo=FALSE}
# boxplot for model year
plot.box <- boxplot(sf$model_year, col = rgb(0, 0.5, 1, alpha = 0.5), main="Model Year Outliers", xlab="Model Year")
```



### Outliers in the feature Electric Range.



The boxplots show several outliers in Battery Electric  Vehicle Type and few outliers in Plug-in Hybrid Electric Vehicle Type.


```{r, echo=FALSE}
# outliers in electric_range by electric type
sf_out_range <- sf %>% select(electric_range, electric_type) %>% 
  group_by(electric_type)  %>%
  arrange(desc(electric_type))


out_range_boxplot <- ggplot(sf_out_range ,aes(electric_range, fill = electric_type)) +
  geom_boxplot(na.rm=TRUE) +
   ggtitle("Outliers in Electric Range by Electric Type") +
  #labs(title= " Battery Electric Vehicles (BEVs) and  Plug-in Hybrid Electric Vehicles (PHEVs)")+
  facet_wrap(~ electric_type) + 
  labs(x = 'Electric_Range')



out_range_boxplot

```


 

## Zero values 


In the distribution of electric range plot for *battery*, the *electric range* has an extremely high value at 0. But we have to remember that *electric range*  was no longer  researched for new BEVs because new cars had an *electric range* of 30 miles or more, in such case, 0 was captured for *electric range*.


All zero values are associated to *battery electric vehicle type* . 

```{r, echo=FALSE}
# Count the number of 0 range values
sf_zero <- sf %>% select(electric_range, electric_type) %>%  
 group_by(electric_type) %>%
  filter(electric_range == 0) %>%
 summarise(Count_0_range = n(), .groups = "drop") 


cap <- "Count of vehicles with 0 range by electric type"
tt(sf_zero, caption = cap)
```

Distribution of electric range across the battery electric type.


```{r,echo=FALSE}
# Count the number of electric range by type
battery.range <- sf %>% select(electric_range, electric_type) %>% 
  filter(electric_type == "battery") %>%
  count(electric_range) %>%
  arrange(desc(electric_range)) %>% 
  mutate(pct_total_range = scales::percent(round(n /lenght.data,digits = 3)))%>%
           mutate( pct_battery_range = scales::percent(round(n /as.numeric(count.type[1,2]),digits = 3))) %>% arrange(desc(n))


tt(battery.range[1:10,], caption = "Percentage of the first 10 most registered ranges. ")

```
There are 139 761 vehicles with 0 *range*, with respect to dataset length, this is the 59% of the dataset!. 
With respect to the *battery vehicle type* this amount is the 74.7%!
This is a considerable amount of data  with range 0 that is modifying the statistic for this variable, doing it significantly right skewed. Compared to this, the percentage of electric range above 190 is extremely low, therefore these values appear as outliers in the boxplots. 


### Zero values and Clean Alternative Fuel Vehicle (CAFV) Eligibility

Now, I explore the Clean Alternative Fuel Vehicle (CAFV) Eligibility which I called it simply *eligibility* for short. There are three classes:

```{r,  echo=FALSE}
# unique values in eligibility
unique(sf$eligibility)
```

Where  


* "clean"    is *Clean Alternative Fuel Vehicle Eligible*.
* "unknown"  is *Eligibililty unknown as battery range has not been researched*.
* "negative" is  *Not eligible due to low battery range*.

With respect to the length of the dataset, the percentage of each class in *eligibility* is shown  in the table.
```{r,  countting_eligibillity, echo=FALSE}
# Counting eligibility 
count.eligibility <- sf %>% as_tibble() %>% 
  group_by(eligibility) %>% 
  summarise(Number.Of.Eligibility = n(), .groups = "drop") %>% 
  mutate(Percentage = scales::percent(round(Number.Of.Eligibility/lenght.data,digits = 3)))
knitr::kable(count.eligibility, caption = "Percentage of eligibility")
```
From this table, the eligibility *unknown* has the higher amount of entries.

Is there a relation of between  the 0's in *electric range* with the *unknown* category? 

```{r,   echo=FALSE}
# counting eligibility with 0 range
number.cafvs.clean <- sf %>% filter(electric_range==0, eligibility == "cafv") %>% 
  summarise(Observations.clean = n())
number.cafvs.unknown <- sf %>% filter(electric_range==0, eligibility == "unknown") %>% summarise(Observations.unknown = n())
number.cafvs.not <- sf %>% filter(electric_range==0, eligibility == "negative") %>% summarise(Observations.not = n())

sprintf("number of clean eligibility with range 0 : %d", number.cafvs.clean[[1,1]])
sprintf("number of  eligibility unknown with range 0 : %d", number.cafvs.unknown[[1,1]])
sprintf("number of negative with range 0 : %d", number.cafvs.not[[1,1]])

```

All vehicles (139 761) that where registered with 0 range were classified  with *eligibility unknown* and type *battery*.


```{r, echo = FALSE}
# plot electric range against eligibility
ggplot(sf, aes(x = eligibility, y = electric_range, fill = electric_type)) +
  geom_boxplot() +  
  facet_grid(~ electric_type)+
    ggtitle("Eligibility vs. electric range across type") 

```
```{r}
# Compute the mean and media of clean alternative eligibility
tab.clean <- sf %>% select(eligibility, electric_range, electric_type) %>%
  filter(eligibility == "clean") %>%
  group_by(electric_type) %>%
  summarise(Median.Clean = median(electric_range, na.rm = TRUE), Mean.Clean = round(mean(electric_range, na.rm = TRUE)), .groups = "drop")

tt(tab.clean, caption = (" Mean and Median of the eligibility class: clean"))
```

The mean and median of the eligibility class *negative* is below 41 in both type of electric vehicles . 
There is no *unknown* registrations for the plug-in type. The eligibility *unknown* is only registered for
battery type, there is not registration of *unknown* eligibility for plug-in hybrid type.




```{r, echo = FALSE}
# plot eligibility against model year across type
ggplot(sf, aes(x = eligibility, y = model_year, fill = electric_type)) +
  geom_boxplot() +  
  facet_grid(~ electric_type)+
    ggtitle("Eligibility across model year by type") 
  #scale_x_discrete(labels = c("cafv", "unknown", "not"))
```
```{r}
# summary statistic for clean eligibility
sf %>% select(eligibility, model_year, electric_type) %>%
  filter(electric_type == "battery" & eligibility =="clean") %>%
  select(model_year) %>%
  summary(model_year)
```


The median of model_year for the eligibility class is 2018.


```{r}
# plot eligibility against model year
ggplot(sf, aes(x = model_year, y = electric_range, colour = eligibility)) +
  geom_point() +  
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8)) +
  facet_grid(~ eligibility)+
    ggtitle("Electric range & model year across eligibility") 
  #scale_x_discrete(labels = c("cafv", "unknown", "not"))
```



Which model years are associated to these vehicles with 0 range and eligibility unknown? 
`


```{r, echo=FALSE}
# Plot electric year by model year
dist.range.year <- sf %>%
  ggplot(aes(model_year,electric_range, color = electric_type)) +  geom_point(na.rm=TRUE) + 
  facet_wrap(~ electric_type ) +
       labs(title= " Electric Range by Model Year") +
    theme(legend.position = "none") 
dist.range.year

```




The plots above show that  for *battery electric type*, there are 0 range values for year model 2008. Then,  the rest of vehicles registered with 0 range correspond to model years between 2019  and 2025.  The model years 2022, 2023 and 2025 have only 0 range values.

Is there a relation between the number of 0 range values with make? 

It seems that several makes have associated 0 range value. 


```{r}
# plot make and electric range
sf %>% select(make, electric_range,electric_type) %>%
  ggplot(., aes(make, electric_range, colour = electric_type)) + geom_point() +
  facet_grid(rows = vars(electric_type)) +
   labs(title= "Plot of Make vs. electric range") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6)) +
  theme(legend.position = "none") 
  
```



Summarizing exploration about zero modes:

* The zero electric range values correspond to  the class  *Eligibililty unknown as battery range has not been researched* and to the *battery* electric vehicle type only. Most of these values were registered between 2019 and 2025. 

* For *range* different to zero and type *battery* there are associated two eligibility classes: *clean* and *negative*. 
 * The *clean* class has an electric range median of 215 and a median of 2018 for the model year.
 * The *negative* class have range values below 41. 




## Missing values

```{r,  echo=FALSE}
# compute the missing values
sapply(sf,function(x) sum(is.na(x)))
```

The feature electric range has also missing values. 

```{r,  echo=FALSE}
# Percentage of missing values with respect to the total number  of data.
percentage.miss <- function(x) {sum(is.na(x)) / length(x)*100}

# missing values per column
sprintf("percentage_miss_range: %s", round(apply(sf[5], 2, percentage.miss), digits = 3))
```
The percentage of missing values in electric_range is 0.015 %, this is to small to do any 
harm. But for a better understanding of the missing values, I explore the columns in order to see where are such missing values.

```{r, where_missing,  echo=FALSE}
# missing values by type
elec_range_na_vals <- sf[is.na(sf$"electric_range"), ]
elec_range_na_vals %>% select("model_year", "electric_type") %>% 
  distinct(model_year, .keep_all=TRUE)
```
The 36 missing values correspond to *model_year* 2025 and to *electric_type   plug-in hybrid electric Vehicle* (PHEV).







## Cleaning data




It seems that the outliers in model year feature is due to the fact that electric vehicles were not popular during  the initial years.  Therefore, for my analysis I consider  Model Years from 2011 till 2025. 

```{r, filter_model_year, echo=FALSE}
# select model years from 2011 to 2025
df <- sf %>%  filter(model_year >= 2011)
```





Next, I replace the zero range values in battery electric type by 215, this is the median of the electric range registered in the clean eligibility.



```{r, echo=FALSE}
# replace the zero values 
df_replaced <- df %>%  
    mutate(Electric.Range = ifelse(electric_range == 0, 215, electric_range)) 
```



```{r,echo=FALSE}
# number of 0 range after replace
df_replaced %>% select(Electric.Range) %>% 
  filter(Electric.Range == 0) %>%
  summarise(Observations_0_range = n())  
 # mutate(Percentage_0_range = Observations_0_range * 100/lenght.data)

```



```{r, echo = FALSE}
# Boxplot for electric range after replacing values
nonzero_out_boxplot  <- df_replaced %>% 
  filter(electric_type == "battery") %>% 
  ggplot(. ,aes(Electric.Range)) +
  geom_boxplot(na.rm=TRUE) +
   ggtitle("Outliers in Electric Range by Electric Type \n
           after removing 0 values") +
  facet_wrap(~ electric_type) + 
  labs(x = 'Electric_Range')

nonzero_out_boxplot
```

```{r}
# mode of electric range after replacing the 0 values
mode.tab.rep <- df_replaced %>% select(Electric.Range, electric_type) %>%
  group_by(electric_type) %>% summarise( across( , mode), .groups = "drop")
  


tt(mode.tab.rep, caption = "Mode for electric range after replacing 0 values")
```




Although I have replaced the 0 values by the median of  rnge in class *clean*, it has not solved the problem of outliers.  Replacing the 0 values with the mean, moves the  mode to the right. New outliers are still present because the number of the replaced values is more than half of the total data. 
There is not correlation between the features, except the slight correlation between model year and eligibility, the outliers does not affect the results of the analysis on the other features. 



# Analyzing Data


## How many registered BEV's and Plug-in electric vehicles are there? 

```{r,  echo=FALSE}
# Count vehicles by class
n_vehicles<- df %>% count(., electric_type ) %>%
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))

knitr::kable(n_vehicles) 
 

```

```{r, count_perc, echo = FALSE}
# Plot the percentage of electric type
ggplot(n_vehicles, aes(x = electric_type, y = n, fill = electric_type)) + geom_col()   + 
  # scale_fill_brewer(palette = "Dark2") +
  geom_text(aes(x = electric_type, y = n, label = paste0(n, " ", " ",  "(", labels , ")" ), vjust = 2.0
                )) + 
 ggtitle(" Count and percentage of vehicles by electric type") +
  theme(plot.title = element_text(hjust = 0.5))
```


## How are the electric vehicle types distributed across the model year? 


```{r,   echo=FALSE}
df %>% group_by(electric_type) %>% count(model_year) %>% 
  arrange(desc(n))%>%
ggplot(aes(x=model_year, y=n, , fill = electric_type)) + geom_bar(stat= "identity") +
  facet_wrap(~ electric_type) +
  xlab("Model Year") + ylab("Frequency") +
   labs(title= "Distribution of Electric Vehicle Type by Model Year from 2011 - 2025") 

```





## How many manufactures (makes)  are registered? Which are the most registered makes?

```{r, echo = FALSE}
# unique makes
unique(df$make)
```


There are 45 manufactures (makes). 
### Makes across electric type

```{r, dist.make, echo=FALSE}
# Distribution of make across  electric type
count.make <- df %>% select(model, electric_type, make) %>%
 # filter(electric_type == "bev") %>%
  group_by(electric_type) %>% 
  count(make) %>% 
  arrange(desc(n)) 

  ggplot(count.make, aes(x=make, y=n , fill = electric_type)) + geom_bar(stat= "identity" ) +
   # scale_y_continuous(trans='log10',
    #                 breaks=trans_breaks('log10', function(x) 10^x),
     #                labels=trans_format('log10', math_format(10^.x))) +
  facet_grid(vars(electric_type)) +
  xlab("Make") + ylab("Frequency in log scale") +
   labs(title= "Distribution of Make by Electric Type") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6)) +
  theme(legend.position = "none") +
     scale_y_continuous(trans='log10',
                    breaks=trans_breaks('log10', function(x) 10^x),
                     labels=trans_format('log10', math_format(10^.x))) 
 


```



### The first 10 manufactures with highest registration in Washington State for battery type

```{r, echo = FALSE}
# count the number of registered vehicles by make
count.make.battery <- df  %>% filter(electric_type == "battery") %>%  group_by(make) %>%
 summarize(Observations.Make.Battery = n(), .groups = "drop") %>%
  arrange(desc(Observations.Make.Battery)) %>% slice(., 1:10)

tt(count.make.battery, caption = "The first 10 makes with highest  battery type registration")


```



```{r, echo=FALSE}
# plot the number of registered vehicles by make and battery type

colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')


fig <- plot_ly(count.make.battery, labels = ~ make, values = ~  Observations.Make.Battery, type = 'pie',

        textposition = 'inside',

        textinfo = 'label+percent',

        insidetextfont = list(color = '#FFFFFF'),

        hoverinfo = 'text',
        
        text = ~paste('$', make,  Observations.Make.Battery),

        marker = list(colors = colors,

                      line = list(color = '#FFFFFF', width = 1)),

                      #The 'pull' attribute can also be used to create space between the sectors

        showlegend = FALSE)
fig <- fig %>% layout(title = ' The top 10 vehicle manufactures for Battery Vehicle Type',

      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),

         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


fig


```


### The first 10 manufactures with highest registration in Washington State for plug-in hybrid type



```{r, echo= FALSE}
# count the number of registered vehicles by make
count.make.plugin <- df  %>% filter(electric_type == "hybrid") %>%  
  group_by(make) %>%
  summarize(Observations.Make.Plugin = n(), .groups = "drop") %>%
  arrange(desc(Observations.Make.Plugin))  %>% 
  slice(., 1:10)

tt(count.make.plugin, caption = "First 10 makes with highest plug-in hybrid type registration")
```


```{r, echo = FALSE}
# plot the number of registered vechicles by make and plug-in typ
colors  <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
fig.plug <- plot_ly(count.make.plugin, labels = ~ make, values = ~  Observations.Make.Plugin, type = 'pie',

        textposition = 'inside',

        textinfo = 'label+percent',

        insidetextfont = list(color = '#FFFFFF'),

        hoverinfo = 'text',
        
        text = ~paste('$', make,  Observations.Make.Plugin),

        marker = list(colors = colors,

                      line = list(color = '#FFFFFF', width = 1)),

                      #The 'pull' attribute can also be used to create space between the sectors

        showlegend = FALSE)
fig.plug <- fig.plug %>% layout(title = ' The top 10 vehicle manufactures for Plug-in  Vehicle Type',

      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),

         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


fig.plug
```


##  Which are the models with highest enrollments? 



```{r, echo = FALSE}
count.model <- df %>% select(make, model, electric_type) %>%
  filter(electric_type == "battery") %>%
  group_by(model, make,) %>% 
   summarize(Count.Model.Battery = n(), .groups = "drop") %>%
  arrange(desc(Count.Model.Battery)) %>% slice(., 1:9)

```

```{r, echo = FALSE}
ggplot(count.model, aes(x = model, y = Count.Model.Battery, fill = make)) + geom_col () + 
  facet_grid(~ make, labeller = labeller( make = label_wrap_gen(width = 25,  multi_line = TRUE))) +
  coord_flip() +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8)) +
   theme(  strip.text = element_text(size = 6))  + 
 ggtitle("Count of Models with battery type \n across the first five makes with highest registration") +
  theme(plot.title = element_text(hjust = 0.5))
  
```

```{r, echo = FALSE}
count.model.plug <- df %>% select(make, model, electric_type) %>%
  filter(electric_type == "hybrid") %>%
  group_by(model, make,) %>% 
   summarize(Count.Model.Plugin = n(), .groups = "drop") %>%
  arrange(desc(Count.Model.Plugin)) %>% slice(., 1:9)

```


```{r, model.plug, echo = FALSE}
ggplot(count.model.plug, aes(x = model, y = Count.Model.Plugin, fill = make)) + geom_col () + 
  facet_grid(~ make, labeller = labeller(make = label_wrap_gen(width = 25,  multi_line = TRUE))) +
   coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8)) +
   theme(  strip.text = element_text(size = 6)) +
 ggtitle("Count of Models with plug-in type  \n 
         across the first five makes with highest registration") +
  theme(plot.title = element_text(hjust = 0.5))
  
```










## Eligibility  by type

```{r, echo = FALSE}
# plot eligibility class by type
ggplot(sf, aes(x= eligibility,  group= electric_type)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="eligibility") + 
   ggtitle("Percentage of eligibility class across electric type") +
    facet_grid(~ electric_type) +
    scale_y_continuous(labels = scales::percent)
```











## Which is the city with most registration?

```{r, echo = FALSE}
city.subset <- sf %>% select(city, electric_type) %>%
  group_by(electric_type) %>%
  count(city) %>% filter(n > 1000) 

city.subset

ggplot(city.subset, aes(x = city, y = n, fill = electric_type)) + geom_histogram(stat = "identity") +
  facet_grid(electric_type~.) +
       xlab("city") + ylab("Frequency") +
       labs(title= "Distribution of cities across electric type") +
       theme(legend.position = "none") +
   scale_fill_manual(values = darkcols[3:4]) +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8)) +
   theme(  strip.text = element_text(size = 6))
      
```


Seattle is the city with  the highest registered vehicles battery and plug-in type.  Across the Washington Cities there are more battery type vehicles registered  than plug-in. 

# Conclusions

* Most of the electric  vehicles  registered between 2011 to 2025 are battery type, with near  80 % of total number of registered vehicles. Among electric vehicles in this class, the most frequently registered are:

    *  Model year: 2023
    *  Make: TESLA 
    *  Model: Y (from TESLA)
    *  City: Seattle
    *  Electric Range: after replacing the  zero values the mode is 215 miles. 



* For the plug-in electric vehicle type, the mos frequently entries are:

   * Model year: 2024
   * Make : Toyota
   * Model:  Volt (from Chevrolet) 
   * City: Seatle
   * Electric range: 41 miles









